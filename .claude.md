# Claude Code Tamagotchi - Docker Development Environment

## Project Overview

This is a Claude Code statusline pet (Tamagotchi) with LM Studio integration for AI-powered behavioral monitoring. The project runs inside a Docker container with SSH access.

## Docker Container Information

- **Container Name**: docker-tamagotchi
- **SSH Access**:
  - Command: `ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost`
  - Working directory: `/home/user/tamagotchi-dev/`
  - Port: 8224 (SSH)

## Docker Administration (Root Access)

### Installing Packages and System Updates

The Docker container requires root access for installing packages. Use `docker exec` to run commands with sudo from the host machine:

```bash
# Install single package
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y PACKAGE_NAME"

# Install multiple packages
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y package1 package2 package3"

# Verify installation
docker exec docker-tamagotchi bash -c "which COMMAND_NAME && COMMAND_NAME --version"
```

### Examples

Install jq (JSON parser):
```bash
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y jq && jq --version"
```

Install build tools:
```bash
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y build-essential git curl"
```

### Why Not SSH with sudo?

The container is locked down - sudo from SSH requires a password. Use `docker exec` from the host machine instead:

- **INCORRECT**: `ssh user@localhost "sudo apt-get install jq"` (requires password)
- **CORRECT**: `docker exec docker-tamagotchi bash -c "sudo apt-get install -y jq"`

## LM Studio Integration

The pet communicates with LM Studio running on the host machine for AI-powered feedback and violation detection.

### Network Configuration

**CRITICAL**: Docker containers cannot use `localhost` to reach the host machine. Use `host.docker.internal` instead:

- **Host Machine**: `http://localhost:1234/v1`
- **Docker Container**: `http://host.docker.internal:1234/v1`

### Environment Configuration (.env)

The `.env` file in the Docker container must use `host.docker.internal`:

```bash
# CORRECT for Docker:
LM_STUDIO_URL=http://host.docker.internal:1234/v1

# INCORRECT for Docker (will fail):
LM_STUDIO_URL=http://localhost:1234/v1
```

## Running Tests

### Test Suite Location

- **Host**: `/Users/sp/mounts-docker/docker-tamagotchi/tamagotchi-dev/test-complete.sh`
- **Docker**: `/home/user/tamagotchi-dev/test-complete.sh`

### Running Tests in Docker

SSH into container and run:
```bash
ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost
cd /home/user/tamagotchi-dev
./test-complete.sh
```

Or from host machine:
```bash
ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost "cd /home/user/tamagotchi-dev && ./test-complete.sh"
```

### Test Dependencies

The test suite requires these tools to be installed in Docker:

- **jq**: JSON parser (required for tests 7-13)
- **bun**: JavaScript runtime (required for tests 14-18)
- **curl**: HTTP client (usually pre-installed)

Install missing dependencies:
```bash
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y jq"
```

## File Synchronization

### Copying Files to Docker

Use `ssh` with cat redirection to copy files:

```bash
# Copy single file
cat local-file.txt | ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost "cat > /home/user/tamagotchi-dev/remote-file.txt"

# Copy and set executable
cat test-complete.sh | ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost "cat > /home/user/tamagotchi-dev/test-complete.sh && chmod +x /home/user/tamagotchi-dev/test-complete.sh"
```

### Copying Files from Docker

```bash
ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost "cat /home/user/tamagotchi-dev/remote-file.txt" > local-file.txt
```

## Development Workflow

### Git Branch Workflow

**CRITICAL**: ALL work must be done on `dev-haltingstate` branch, NOT on `main`.

1. **Always work on dev-haltingstate branch**:
   ```bash
   git checkout dev-haltingstate
   git pull origin dev-haltingstate
   git merge origin/main  # Keep dev branch synchronized with main
   ```

2. **Make changes and commit to dev-haltingstate**:
   ```bash
   # Make your changes
   git add .
   git commit -m "description of changes"
   git push origin dev-haltingstate
   git push gogs dev-haltingstate
   ```

3. **Create pull request when ready for production**:
   ```bash
   gh pr create --base main --head dev-haltingstate --title "Release: description"
   ```

4. **After merging PR to main, sync dev branch**:
   ```bash
   git checkout main
   git pull origin main
   git push gogs main
   git checkout dev-haltingstate
   git merge main
   git push origin dev-haltingstate
   git push gogs dev-haltingstate
   ```

**NEVER commit directly to main** - all changes go through dev-haltingstate → PR → main workflow.

### Docker Development Workflow

1. **Make changes on host machine** in `/Users/sp/mounts-docker/docker-tamagotchi/tamagotchi-dev/`
2. **Copy files to Docker** using SSH + cat pattern (if testing in container)
3. **Run tests in Docker** to verify changes work in container environment
4. **Commit changes from host machine** on dev-haltingstate branch

## Troubleshooting

### Cannot connect to LM Studio from Docker

**Symptom**: Tests fail with "Cannot connect to LM Studio server"

**Solution**: Check `.env` file uses `host.docker.internal:1234` not `localhost:1234`

```bash
ssh -i ~/.ssh/id_ed25519_docker -p 8224 user@localhost "grep LM_STUDIO_URL /home/user/tamagotchi-dev/.env"
```

### Tests fail with "jq: command not found"

**Solution**: Install jq in Docker container

```bash
docker exec docker-tamagotchi bash -c "sudo apt-get update && sudo apt-get install -y jq"
```

### TypeScript build fails with "Browser build cannot import Node.js builtin"

**Solution**: Use `--target=node` flag with bun build:

```bash
bun build src/index.ts --outdir /tmp/test-build --target=node
```

## Container Management

### Check Container Status

```bash
docker ps -a | grep docker-tamagotchi
```

### View Container Logs

```bash
docker logs docker-tamagotchi
```

### Restart Container

```bash
docker restart docker-tamagotchi
```

## TODO: Permanent Package Installation

The current approach (using `docker exec` with `sudo apt-get install`) installs packages temporarily. Packages will be lost if the container is rebuilt.

**For permanent installation**, packages should be added to the Docker image definition:

- Add `RUN apt-get update && apt-get install -y jq` to Dockerfile (if exists)
- Or create setup script that runs on container startup
- Or use docker-compose.yml with build instructions

**Required packages for full test suite**:
- jq (JSON parser)
- build-essential (C compiler, make, etc.)
- git (version control)
- curl (HTTP client)

**Location to investigate**:
- `/Users/sp/mounts-docker/docker-tamagotchi/` (check for Dockerfile, docker-compose.yml, setup scripts)
- Container may be pre-built image from registry

## Related Documentation

- `TODO-docker-container-fixes.txt`: Comprehensive Docker environment fixes
- `test-complete.sh`: Full test suite (18 tests)
- `.env.example`: Environment variable reference
- `README.md`: User-facing documentation
